<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Planner</title>
    <style>
        /* --- Basic Setup & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

        :root {
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --primary-color: #3498db;
            --accent-color: #2ecc71; /* Green for shopping */
            --birthday-color: #9b59b6; /* Purple for birthdays */
            --border-color: #ecf0f1;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); font-size: 16px; }

        /* --- Page & Navigation System --- */
        .page-view { display: none; padding: 1rem 1rem 6rem 1rem; }
        .page-view.active { display: block; }
        .page-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1.5rem; }

        nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background-color: var(--card-bg); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); z-index: 100; }
        .nav-btn { background: none; border: none; cursor: pointer; color: var(--text-light); display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 0.7rem; flex-grow: 1; padding: 8px 0; transition: color 0.2s ease; }
        .nav-btn.active { color: var(--primary-color); }
        .nav-btn svg { width: 24px; height: 24px; }
        
        /* --- Floating Action Button (FAB) --- */
        .fab { position: fixed; bottom: 80px; right: 20px; background-color: var(--primary-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; box-shadow: 0 6px 10px rgba(0,0,0,0.15); font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 101; }

        /* --- General Components --- */
        .section { margin-bottom: 2rem; }
        .section-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }
        .placeholder { text-align: center; padding: 2rem; color: var(--text-light); background-color: var(--card-bg); border-radius: 8px; border: 2px dashed var(--border-color); }
        .card { background-color: var(--card-bg); border-radius: 8px; box-shadow: var(--shadow); padding: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem; }
        .card-icon { flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .card-content { flex-grow: 1; overflow: hidden; }
        .card-title { font-weight: 500; font-size: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-subtitle { font-size: 0.85rem; color: var(--text-light); }
        .card-right-content { text-align: right; color: var(--text-light); font-size: 0.9rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 6px; border: none; font-size: 1rem; font-weight: 500; cursor: pointer; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--border-color); color: var(--text-light); }
        .btn-full-width { width: 100%; text-align: center; display: block; margin-top: 1rem; }
        
        /* --- Modal Styles --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.5rem; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1rem; }
        .form-group-inline { display: flex; align-items: center; gap: 10px; }
        .time-inputs { display: flex; gap: 1rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; }

        /* --- Shopping List Specific Styles --- */
        .shopping-list-item { display: flex; align-items: center; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); gap: 1rem; }
        .shopping-list-item:last-child { border-bottom: none; }
        .shopping-list-item input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; accent-color: var(--accent-color); }
        .shopping-list-item label { flex-grow: 1; font-size: 1rem; }
        .shopping-list-item.checked label { text-decoration: line-through; color: var(--text-light); }
    </style>
</head>
<body>

    <main>
        <div id="page-home" class="page-view active">
            <h1 class="page-title">Home Hub</h1>
            <div class="section">
                <h2 class="section-title" id="home-date-title">Today's Events</h2>
                <div id="home-today-events"></div>
            </div>
            <div class="section">
                <h2 class="section-title">Open Shopping Lists</h2>
                <div id="home-shopping-lists"></div>
            </div>
            <button id="home-add-event-fab" class="fab">+</button>
        </div>

        <div id="page-calendar" class="page-view">
            <h1 class="page-title">Calendar</h1>
            <button id="add-event-btn" class="btn btn-primary btn-full-width">Add New Event</button>
            <div class="section" style="margin-top: 2rem;">
                <h2 class="section-title">Upcoming Events</h2>
                <div id="calendar-upcoming-events"></div>
            </div>
        </div>

        <div id="page-shopping" class="page-view">
            <h1 class="page-title">Shopping</h1>
            <button id="add-list-btn" class="btn btn-primary btn-full-width">Create New Shopping List</button>
            <button id="manage-stores-btn" class="btn btn-secondary btn-full-width">Manage Stores & Items</button>
            <div class="section" style="margin-top: 2rem;">
                <h2 class="section-title">Active Lists</h2>
                <div id="shopping-active-lists"></div>
            </div>
        </div>

        <div id="page-meals" class="page-view">
            <h1 class="page-title">Meals</h1>
            <p>Meal planning page is under construction.</p>
        </div>

        <div id="page-settings" class="page-view">
            <h1 class="page-title">Settings</h1>
            <button id="manage-people-btn" class="btn btn-primary btn-full-width">Manage People</button>
        </div>
    </main>

    <nav>
        <button class="nav-btn active" data-page="home">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            <span>Home</span>
        </button>
        <button class="nav-btn" data-page="calendar">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            <span>Calendar</span>
        </button>
        <button class="nav-btn" data-page="shopping">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            <span>Shopping</span>
        </button>
        <button class="nav-btn" data-page="meals">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v2H3zM21 8H3v10c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8zM12 4v4"></path></svg>
            <span>Meals</span>
        </button>
        <button class="nav-btn" data-page="settings">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            <span>Settings</span>
        </button>
    </nav>
    
    <div id="add-event-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">Add New Event</h3>
            <form id="event-form">
                <div class="form-group"><label for="event-title">Event Title</label><input type="text" id="event-title" required></div>
                <div class="form-group"><label for="event-date">Date</label><input type="date" id="event-date" required></div>
                <div class="form-group form-group-inline"><input type="checkbox" id="event-all-day"><label for="event-all-day">All-day event</label></div>
                <div class="form-group" id="event-time-container">
                    <label>Time</label>
                    <div class="time-inputs">
                        <input type="time" id="event-start-time" required>
                        <input type="time" id="event-end-time" required>
                    </div>
                </div>
                <div class="form-group"><label for="event-person">Assign to</label><select id="event-person"><option value="0">None</option></select></div>
                <div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Cancel</button><button type="submit" class="btn btn-primary">Save Event</button></div>
            </form>
        </div>
    </div>

    <div id="add-list-modal" class="modal"><div class="modal-content"><h3 class="modal-title">Create Shopping List</h3><form id="list-form"><div class="form-group"><label for="list-name">List Name</label><input type="text" id="list-name" placeholder="e.g., Weekly Groceries" required></div><div class="form-group"><label for="list-store">Store</label><select id="list-store" required></select></div><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Cancel</button><button type="submit" class="btn btn-primary">Next</button></div></form></div></div>
    <div id="manage-stores-modal" class="modal"><div class="modal-content"><h3 class="modal-title">Manage Stores</h3><div id="stores-list"></div><form id="add-store-form" style="margin-top: 1rem; display: flex; gap: 0.5rem;"><input type="text" id="new-store-name" placeholder="Add new store" style="flex-grow: 1;" required><button type="submit" class="btn btn-primary">+</button></form><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Close</button></div></div></div>
    <div id="manage-items-modal" class="modal"><div class="modal-content"><h3 class="modal-title" id="manage-items-title">Manage Items</h3><div id="master-items-list"></div><form id="add-master-item-form" style="margin-top: 1rem; display: flex; gap: 0.5rem;"><input type="text" id="new-master-item-name" placeholder="Add new item" style="flex-grow: 1;" required><button type="submit" class="btn btn-primary">+</button></form><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="openModal('manage-stores-modal')">Back to Stores</button></div></div></div>
    <div id="add-items-to-list-modal" class="modal"><div class="modal-content"><h3 class="modal-title" id="add-items-title">Add Items to List</h3><form id="add-new-item-to-list-form" style="margin-bottom: 1rem; display: flex; gap: 0.5rem;"><input type="text" id="new-list-item-name" placeholder="Add new item to list" style="flex-grow: 1;"><button type="submit" class="btn btn-primary">+</button></form><div id="add-items-master-list" style="max-height: 30vh; overflow-y: auto;"></div><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Cancel</button><button id="save-list-items-btn" type="button" class="btn btn-primary">Create List</button></div></div></div>
    <div id="view-list-modal" class="modal"><div class="modal-content"><h3 class="modal-title" id="view-list-title">Shopping List</h3><div id="view-list-items"></div><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Close</button><button id="complete-list-btn" type="button" class="btn btn-primary" style="background-color: var(--accent-color);">Complete List</button></div></div></div>
    <div id="manage-people-modal" class="modal"><div class="modal-content"><h3 class="modal-title">Manage People</h3><div id="people-list"></div><form id="add-person-form" style="margin-top: 1rem;"><div class="form-group"><label for="new-person-name">Name</label><input type="text" id="new-person-name" required></div><div class="form-group"><label for="new-person-bday">Birthday</label><input type="date" id="new-person-bday" required></div><button type="submit" class="btn btn-primary btn-full-width">Add Person</button></form><div class="modal-actions"><button type="button" class="btn btn-secondary" onclick="closeAllModals()">Close</button></div></div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Globals & Constants ---
    const DB_NAME = 'FamilyPlannerDB';
    const DB_VERSION = 4; // Incremented for the schema fix
    let db;
    let currentStoreIdForItems = null;
    let currentListForAddingItems = null;

    // --- Page Navigation ---
    const navButtons = document.querySelectorAll('.nav-btn');
    const pages = document.querySelectorAll('.page-view');
    function navigateTo(pageId) {
        pages.forEach(p => p.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        navButtons.forEach(b => b.classList.remove('active'));
        document.querySelector(`.nav-btn[data-page="${pageId}"]`).classList.add('active');
    }
    navButtons.forEach(button => button.addEventListener('click', () => navigateTo(button.dataset.page)));

    // --- Modal Controls ---
    const modals = document.querySelectorAll('.modal');
    window.openModal = (modalId) => {
        modals.forEach(m => m.classList.remove('active'));
        document.getElementById(modalId).classList.add('active');
    };
    window.closeAllModals = () => modals.forEach(m => m.classList.remove('active'));
    modals.forEach(modal => modal.addEventListener('click', e => { if (e.target === modal) closeAllModals(); }));

    // --- Button Event Listeners ---
    const openEventModal = async () => {
        await populatePeopleDropdown();
        openModal('add-event-modal');
    };
    document.getElementById('home-add-event-fab').addEventListener('click', openEventModal);
    document.getElementById('add-event-btn').addEventListener('click', openEventModal);
    document.getElementById('add-list-btn').addEventListener('click', async () => { await populateStoreDropdown(); openModal('add-list-modal'); });
    document.getElementById('manage-stores-btn').addEventListener('click', () => { renderStoresManagement(); openModal('manage-stores-modal'); });
    document.getElementById('manage-people-btn').addEventListener('click', () => { renderPeopleManagement(); openModal('manage-people-modal'); });

    // --- IndexedDB ---
    function initDB() {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = e => console.error("DB Error:", e.target.errorCode);
        request.onsuccess = e => { db = e.target.result; loadAllData(); };
        
        // --- THIS IS THE CORRECTED DATABASE SCHEMA LOGIC ---
        request.onupgradeneeded = e => {
            db = e.target.result;
            const transaction = e.target.transaction;

            // Create stores and indexes robustly
            if (!db.objectStoreNames.contains('events')) {
                const eventsStore = db.createObjectStore('events', { keyPath: 'id', autoIncrement: true });
                eventsStore.createIndex('date', 'date', { unique: false });
            }
            if (!db.objectStoreNames.contains('shoppingLists')) {
                const shoppingListsStore = db.createObjectStore('shoppingLists', { keyPath: 'id', autoIncrement: true });
                shoppingListsStore.createIndex('status', 'status', { unique: false });
            }
            if (!db.objectStoreNames.contains('shoppingListItems')) {
                const shoppingListItemsStore = db.createObjectStore('shoppingListItems', { keyPath: 'id', autoIncrement: true });
                shoppingListItemsStore.createIndex('listId', 'listId', { unique: false });
            }
            if (!db.objectStoreNames.contains('stores')) {
                db.createObjectStore('stores', { keyPath: 'id', autoIncrement: true });
            }
            if (!db.objectStoreNames.contains('masterItems')) {
                const masterItemsStore = db.createObjectStore('masterItems', { keyPath: 'id', autoIncrement: true });
                masterItemsStore.createIndex('storeId', 'storeId', { unique: false });
            }
            if (!db.objectStoreNames.contains('people')) {
                db.createObjectStore('people', { keyPath: 'id', autoIncrement: true });
            }

            // This is the key fix: It specifically checks if the index is missing and adds it.
            if (db.objectStoreNames.contains('shoppingLists')) {
                const shoppingListsStore = transaction.objectStore('shoppingLists');
                if (!shoppingListsStore.indexNames.contains('status')) {
                    shoppingListsStore.createIndex('status', 'status', { unique: false });
                }
            }
        };
    }

    // --- Data Loading & Rendering ---
    async function loadAllData() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        document.getElementById('home-date-title').innerText = `Today, ${today.toLocaleDateString(undefined, {month: 'long', day: 'numeric'})}`;
        
        // Combine real events and birthdays
        const events = await getAllFromDB('events');
        const people = await getAllFromDB('people');
        const allDisplayEvents = generateBirthdayEvents(people, today).concat(events);

        renderHomeDashboard(allDisplayEvents, todayStr);
        renderCalendarPage(allDisplayEvents, todayStr);
        renderShoppingPage();
    }

    function generateBirthdayEvents(people, today) {
        const birthdayEvents = [];
        const currentYear = today.getFullYear();
        people.forEach(person => {
            if (!person.birthday) return;
            const bday = new Date(person.birthday + 'T00:00:00');
            const thisYearsBday = new Date(currentYear, bday.getMonth(), bday.getDate());
            birthdayEvents.push({
                id: `bday-${person.id}`,
                title: `${person.name}'s Birthday`,
                date: thisYearsBday.toISOString().split('T')[0],
                isAllDay: true,
                isBirthday: true
            });
        });
        return birthdayEvents;
    }
    
    async function renderHomeDashboard(allEvents, todayStr) {
        // Render Today's Events
        const todayEvents = allEvents
            .filter(e => e.date === todayStr)
            .sort((a,b) => (a.startTime || '00:00').localeCompare(b.startTime || '00:00'));
        renderEventList(document.getElementById('home-today-events'), todayEvents, false, 'No events for today.');

        // Render Open Shopping Lists
        const openLists = await getFromDB('shoppingLists', 'status', 'open');
        const listsContainer = document.getElementById('home-shopping-lists');
        listsContainer.innerHTML = '';
        if (openLists.length > 0) {
            for (const list of openLists) {
                const store = await getFromDBbyKey('stores', list.storeId);
                listsContainer.innerHTML += `<div class="card"><div class="card-content"><div class="card-title">${list.name}</div><div class="card-subtitle">${store.name}</div></div></div>`;
            }
        } else {
            listsContainer.innerHTML = '<div class="placeholder">No open shopping lists.</div>';
        }
    }

    async function renderCalendarPage(allEvents, todayStr) {
        const upcoming = allEvents
            .filter(e => e.date >= todayStr)
            .sort((a, b) => a.date.localeCompare(b.date) || (a.startTime || '').localeCompare(b.startTime || ''));
        renderEventList(document.getElementById('calendar-upcoming-events'), upcoming, true, 'No upcoming events.');
    }
    
    async function renderEventList(container, events, showDate, placeholderText) {
        container.innerHTML = '';
        const people = await getAllFromDB('people');
        const peopleMap = new Map(people.map(p => [p.id, p.name]));

        if (events.length === 0) {
            container.innerHTML = `<div class="placeholder">${placeholderText}</div>`;
            return;
        }

        let lastDate = '';
        events.forEach(event => {
            if (showDate && event.date !== lastDate) {
                const dateHeader = document.createElement('h3');
                dateHeader.textContent = new Date(event.date + 'T00:00:00').toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
                dateHeader.style.cssText = 'margin-top: 1.5rem; color: var(--text-light); font-weight: 500;';
                container.appendChild(dateHeader);
                lastDate = event.date;
            }
            const timeText = event.isAllDay ? 'All Day' : `${formatTime(event.startTime)} - ${formatTime(event.endTime)}`;
            const assignedTo = event.personId && peopleMap.has(event.personId) ? peopleMap.get(event.personId) : '';

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-icon" style="background-color: ${event.isBirthday ? 'var(--birthday-color)' : 'var(--primary-color)'};">
                    ${event.isBirthday ? 
                        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>` : 
                        `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`
                    }
                </div>
                <div class="card-content">
                    <div class="card-title">${event.title}</div>
                    ${assignedTo ? `<div class="card-subtitle">${assignedTo}</div>` : ''}
                </div>
                <div class="card-right-content">${timeText}</div>
            `;
            container.appendChild(card);
        });
    }

    // --- Form Handlers ---
    document.getElementById('event-all-day').addEventListener('change', (e) => {
        const timeContainer = document.getElementById('event-time-container');
        timeContainer.style.display = e.target.checked ? 'none' : 'block';
        document.getElementById('event-start-time').required = !e.target.checked;
        document.getElementById('event-end-time').required = !e.target.checked;
    });

    document.getElementById('event-form').addEventListener('submit', async e => {
        e.preventDefault();
        const isAllDay = document.getElementById('event-all-day').checked;
        const event = {
            title: document.getElementById('event-title').value,
            date: document.getElementById('event-date').value,
            isAllDay: isAllDay,
            startTime: isAllDay ? null : document.getElementById('event-start-time').value,
            endTime: isAllDay ? null : document.getElementById('event-end-time').value,
            personId: parseInt(document.getElementById('event-person').value) || null
        };
        await addToDB('events', event);
        e.target.reset();
        document.getElementById('event-time-container').style.display = 'block';
        closeAllModals();
        loadAllData();
    });

    document.getElementById('add-person-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const person = {
            name: document.getElementById('new-person-name').value,
            birthday: document.getElementById('new-person-bday').value
        };
        await addToDB('people', person);
        e.target.reset();
        renderPeopleManagement();
    });

    document.getElementById('add-store-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const storeNameInput = document.getElementById('new-store-name');
        await addToDB('stores', { name: storeNameInput.value });
        storeNameInput.value = '';
        renderStoresManagement();
    });
    
    document.getElementById('add-master-item-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const itemNameInput = document.getElementById('new-master-item-name');
        await addToDB('masterItems', { name: itemNameInput.value, storeId: currentStoreIdForItems });
        itemNameInput.value = '';
        renderMasterItems(currentStoreIdForItems, document.getElementById('manage-items-title').innerText.replace('Items for ',''));
    });

    document.getElementById('list-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        currentListForAddingItems = {
            name: document.getElementById('list-name').value,
            storeId: parseInt(document.getElementById('list-store').value),
            createdAt: new Date(),
            status: 'open'
        };
        await renderAddItemsToListModal(currentListForAddingItems.storeId);
        openModal('add-items-to-list-modal');
    });

    document.getElementById('add-new-item-to-list-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newItemNameInput = document.getElementById('new-list-item-name');
        const newItemName = newItemNameInput.value.trim();
        if (newItemName === '') return;
        
        // Add to master list in DB
        const newItem = { name: newItemName, storeId: currentListForAddingItems.storeId };
        const newItemId = await addToDB('masterItems', newItem);
        
        // Add to the UI of the current modal
        const container = document.getElementById('add-items-master-list');
        const div = document.createElement('div');
        div.className = 'shopping-list-item';
        div.innerHTML = `<input type="checkbox" id="add-item-${newItemId}" data-name="${newItemName}" checked><label for="add-item-${newItemId}">${newItemName}</label>`;
        container.prepend(div);
        
        newItemNameInput.value = '';
    });
    
    document.getElementById('save-list-items-btn').addEventListener('click', async () => {
        const listId = await addToDB('shoppingLists', currentListForAddingItems);
        const itemCheckboxes = document.querySelectorAll('#add-items-master-list input[type="checkbox"]:checked');
        
        for (const box of Array.from(itemCheckboxes)) {
            await addToDB('shoppingListItems', { listId: listId, name: box.dataset.name, isChecked: false });
        }
        
        closeAllModals();
        loadAllData();
        document.getElementById('list-form').reset();
    });


    // --- Helper & Utility Functions ---
    const formatTime = (timeStr) => !timeStr ? '' : new Date(`1970-01-01T${timeStr}`).toLocaleTimeString([], {hour: 'numeric', minute:'2-digit'});

    async function renderShoppingPage() {
        const openLists = await getFromDB('shoppingLists', 'status', 'open');
        const container = document.getElementById('shopping-active-lists');
        container.innerHTML = '';
        if(openLists.length === 0) {
            container.innerHTML = '<div class="placeholder">No active lists.</div>';
            return;
        }
        for (const list of openLists) {
            const store = await getFromDBbyKey('stores', list.storeId);
            const card = document.createElement('div');
            card.className = 'card';
            card.style.cursor = 'pointer';
            card.innerHTML = `<div class="card-icon" style="background-color: var(--accent-color);"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg></div><div class="card-content"><div class="card-title">${list.name}</div><div class="card-subtitle">${store.name}</div></div>`;
            card.onclick = () => viewShoppingList(list.id);
            container.appendChild(card);
        }
    }
    async function populateStoreDropdown() {
        const stores = await getAllFromDB('stores');
        const select = document.getElementById('list-store');
        select.innerHTML = '<option value="">-- Select a Store --</option>';
        stores.forEach(store => { select.innerHTML += `<option value="${store.id}">${store.name}</option>`; });
    }
    async function renderStoresManagement() {
        const stores = await getAllFromDB('stores');
        const container = document.getElementById('stores-list');
        container.innerHTML = '';
        if(stores.length === 0) {
            container.innerHTML = '<div class="placeholder">No stores added yet.</div>';
            return;
        }
        stores.forEach(store => {
            const div = document.createElement('div');
            div.className = 'card';
            div.style.cursor = 'pointer';
            div.innerHTML = `<div class="card-content"><div class="card-title">${store.name}</div></div>`;
            div.onclick = () => { currentStoreIdForItems = store.id; renderMasterItems(store.id, store.name); openModal('manage-items-modal'); };
            container.appendChild(div);
        });
    }
    async function renderMasterItems(storeId, storeName) {
        document.getElementById('manage-items-title').innerText = `Items for ${storeName}`;
        const items = await getFromDB('masterItems', 'storeId', storeId);
        const container = document.getElementById('master-items-list');
        container.innerHTML = '';
        if(items.length === 0) {
            container.innerHTML = '<div class="placeholder">No master items.</div>';
            return;
        }
        items.forEach(item => { container.innerHTML += `<div class="card"><div class="card-content">${item.name}</div></div>`; });
    }
    async function renderAddItemsToListModal(storeId) {
        const masterItems = await getFromDB('masterItems', 'storeId', storeId);
        const container = document.getElementById('add-items-master-list');
        container.innerHTML = '';
        masterItems.forEach(item => { container.innerHTML += `<div class="shopping-list-item"><input type="checkbox" id="add-item-${item.id}" data-name="${item.name}"><label for="add-item-${item.id}">${item.name}</label></div>`; });
    }
    async function viewShoppingList(listId) {
        const list = await getFromDBbyKey('shoppingLists', listId);
        const items = await getFromDB('shoppingListItems', 'listId', listId);
        const store = await getFromDBbyKey('stores', list.storeId);
        document.getElementById('view-list-title').innerText = `${list.name} (${store.name})`;
        const container = document.getElementById('view-list-items');
        container.innerHTML = '';
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = `shopping-list-item ${item.isChecked ? 'checked' : ''}`;
            div.innerHTML = `<input type="checkbox" id="view-item-${item.id}" ${item.isChecked ? 'checked' : ''}><label for="view-item-${item.id}">${item.name}</label>`;
            const checkbox = div.querySelector('input');
            checkbox.onchange = async () => { div.classList.toggle('checked'); await updateInDB('shoppingListItems', { ...item, isChecked: checkbox.checked }); };
            container.appendChild(div);
        });
        document.getElementById('complete-list-btn').onclick = async () => { await updateInDB('shoppingLists', { ...list, status: 'completed' }); closeAllModals(); loadAllData(); };
        openModal('view-list-modal');
    }
    async function populatePeopleDropdown() {
        const people = await getAllFromDB('people');
        const select = document.getElementById('event-person');
        select.innerHTML = '<option value="0">None</option>';
        people.forEach(p => select.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    }
    async function renderPeopleManagement() {
        const people = await getAllFromDB('people');
        const container = document.getElementById('people-list');
        container.innerHTML = '';
        if (people.length === 0) {
            container.innerHTML = '<div class="placeholder">No people added yet.</div>';
            return;
        }
        people.forEach(p => container.innerHTML += `<div class="card"><div class="card-content"><div class="card-title">${p.name}</div><div class="card-subtitle">Birthday: ${new Date(p.birthday+'T00:00:00').toLocaleDateString()}</div></div></div>`);
    }
    
    // --- DB Helper Functions ---
    function getFromDB(storeName, indexName, value) { return new Promise((resolve, reject) => { const store = db.transaction(storeName).objectStore(storeName); const request = store.index(indexName).getAll(value); request.onsuccess = () => resolve(request.result); request.onerror = e => reject(e.target.error); }); }
    function getFromDBbyKey(storeName, key) { return new Promise((resolve, reject) => { const request = db.transaction(storeName).objectStore(storeName).get(key); request.onsuccess = () => resolve(request.result); request.onerror = e => reject(e.target.error); }); }
    function getAllFromDB(storeName) { return new Promise((resolve, reject) => { const request = db.transaction(storeName).objectStore(storeName).getAll(); request.onsuccess = () => resolve(request.result); request.onerror = e => reject(e.target.error); }); }
    function addToDB(storeName, data) { return new Promise((resolve, reject) => { const request = db.transaction(storeName, 'readwrite').objectStore(storeName).add(data); request.onsuccess = () => resolve(request.result); request.onerror = e => reject(e.target.error); }); }
    function updateInDB(storeName, data) { return new Promise((resolve, reject) => { const request = db.transaction(storeName, 'readwrite').objectStore(storeName).put(data); request.onsuccess = () => resolve(request.result); request.onerror = e => reject(e.target.error); }); }
    
    // --- Initial Load ---
    initDB();
});
</script>

</body>
</html>
